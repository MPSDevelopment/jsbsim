name: Build JSBSim

on:
  push:
    branches:
      - main
      - "v1.1"
    tags:
      - 'v1.1*'
      - 'v1.2*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            artifact: JSBSim-linux
            binary_name: JSBSim
            cmake_generator: "Ninja"
          - os: macos-14
            artifact: JSBSim-macos
            binary_name: JSBSim-macos-arm64
            cmake_generator: "Unix Makefiles"
          - os: windows-2022
            artifact: JSBSim-windows
            binary_name: JSBSim.exe
            cmake_generator: "Ninja"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout JSBSim
        uses: actions/checkout@v6

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libssl-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja openssl@3

      - name: Install MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-openssl

      - name: Configure CMake (Unix)
        if: runner.os != 'Windows'
        run: |
          CMAKE_EXTRA_FLAGS=""
          if [[ "$OSTYPE" == "darwin"* ]]; then
            CMAKE_EXTRA_FLAGS="-DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)"
          fi
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_PYTHON_MODULE=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            $CMAKE_EXTRA_FLAGS

      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_PYTHON_MODULE=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_SHARED_LIBS=OFF \
            -DOPENSSL_USE_STATIC_LIBS=TRUE \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build (Unix)
        if: runner.os != 'Windows'
        run: |
          cmake --build build --config Release -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          cmake --build build --config Release -j$(nproc)

      - name: Copy binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cp build/src/JSBSim "${{ github.workspace }}/${{ matrix.binary_name }}"
          chmod +x "${{ github.workspace }}/${{ matrix.binary_name }}"
          if [[ "$OSTYPE" == "darwin"* ]]; then
            xattr -cr "${{ github.workspace }}/${{ matrix.binary_name }}"
          fi

      - name: Copy binary (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          cp build/src/JSBSim.exe "${{ github.workspace }}/${{ matrix.binary_name }}"

      - name: Test binary (Unix)
        if: runner.os != 'Windows'
        run: |
          "${{ github.workspace }}/${{ matrix.binary_name }}" --help || true

      - name: Test binary (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          "${{ github.workspace }}/${{ matrix.binary_name }}" --help || true

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact }}
          path: ${{ github.workspace }}/${{ matrix.binary_name }}
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/v1.1' || startsWith(github.ref, 'refs/tags/v1.1') || startsWith(github.ref, 'refs/tags/v1.2')

    steps:
      - name: Set version
        id: version
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/v1.1" ]] || [[ "${{ github.ref }}" == refs/tags/v1.1* ]]; then
            echo "version=1.1" >> $GITHUB_OUTPUT
          else
            echo "version=1.2" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}-${{ github.run_number }}
          name: JSBSim v${{ steps.version.outputs.version }}-${{ github.run_number }}
          body: |
            JSBSim v${{ steps.version.outputs.version }} flight dynamics model binaries.

            **Platforms**:
            - Linux (x64)
            - macOS ARM64 (Apple Silicon)
            - Windows (x64)
          files: |
            ./artifacts/JSBSim-linux/JSBSim
            ./artifacts/JSBSim-macos/JSBSim-macos-arm64
            ./artifacts/JSBSim-windows/JSBSim.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
